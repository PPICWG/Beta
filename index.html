<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Container Box Visualizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
  <script src="https://unpkg.com/@react-three/fiber@8.0.27/dist/react-three-fiber.umd.js"></script>
  <script src="https://unpkg.com/@react-three/drei@9.57.0/dist/drei.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useRef, useEffect } = React;
  const R3F = window.ReactThreeFiber; // This is how we access R3F with UMD build
  const { Canvas, useFrame } = R3F;
  const THREE = window.THREE; // Access THREE.js from global
  const { OrbitControls } = THREE;
  const { v4: uuidv4 } = uuid;
  
    // Default container setup
    const defaultContainer = {
      width: 10,
      height: 8,
      depth: 20,
      layers: [
        { id: 'layer-1', boxes: [], order: 0 },
        { id: 'layer-2', boxes: [], order: 1 },
        { id: 'layer-3', boxes: [], order: 2 }
      ]
    };

    // 2D View Component
    function Layer2DView({ layer, container }) {
      const canvasRef = useRef(null);

      useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;

        // Clear canvas
        ctx.clearRect(0, 0, container.width * 40, container.height * 40);

        // Draw each box (scaled up for visibility)
        layer.boxes.forEach(box => {
          ctx.fillStyle = box.color;
          ctx.fillRect(
            box.position.x * 40, 
            box.position.y * 40, 
            box.width * 40, 
            box.height * 40
          );
          ctx.strokeRect(
            box.position.x * 40, 
            box.position.y * 40, 
            box.width * 40, 
            box.height * 40
          );
          
          // Box label
          ctx.fillStyle = '#000';
          ctx.font = '10px Arial';
          ctx.fillText(
            `${box.width}x${box.height}x${box.depth}`,
            box.position.x * 40 + 5,
            box.position.y * 40 + 15
          );
        });
      }, [layer, container]);

      return (
        <div className="overflow-auto border border-gray-300 p-2">
          <canvas 
            ref={canvasRef} 
            width={container.width * 40} 
            height={container.height * 40}
            className="bg-white"
          />
        </div>
      );
    }

    // 3D Box Component
    function Box3D({ box }) {
      return (
        <mesh position={[box.position.x, box.position.y, box.position.z]}>
          <boxGeometry args={[box.width, box.height, box.depth]} />
          <meshStandardMaterial color={box.color} />
        </mesh>
      );
    }

    // 3D View Component
    function Container3DView({ container }) {
      const [doorOpen, setDoorOpen] = useState(false);
      const doorRef = useRef();

      // Animate door when state changes
      useFrame(() => {
        if (doorRef.current) {
          doorRef.current.rotation.y = THREE.MathUtils.lerp(
            doorRef.current.rotation.y,
            doorOpen ? Math.PI / 2 : 0,
            0.1
          );
        }
      });

      return (
        <Canvas camera={{ position: [15, 15, 15], fov: 50 }}>
          <ambientLight intensity={0.5} />
          <spotLight position={[10, 15, 10]} angle={0.15} penumbra={1} intensity={1} />
          <pointLight position={[-10, -10, -10]} intensity={0.5} />
          
          {/* Container structure */}
          <group>
            {/* Floor */}
            <mesh position={[0, -container.height/2, 0]} rotation={[-Math.PI/2, 0, 0]}>
              <planeGeometry args={[container.width, container.depth]} />
              <meshStandardMaterial color="#aaa" />
            </mesh>
            
            {/* Walls */}
            <mesh position={[0, 0, -container.depth/2]}>
              <boxGeometry args={[container.width, container.height, 0.1]} />
              <meshStandardMaterial color="#888" />
            </mesh>
            
            {/* Left wall */}
            <mesh position={[-container.width/2, 0, 0]}>
              <boxGeometry args={[0.1, container.height, container.depth]} />
              <meshStandardMaterial color="#777" />
            </mesh>
            
            {/* Right wall */}
            <mesh position={[container.width/2, 0, 0]}>
              <boxGeometry args={[0.1, container.height, container.depth]} />
              <meshStandardMaterial color="#777" />
            </mesh>
            
            {/* Top */}
            <mesh position={[0, container.height/2, 0]}>
              <boxGeometry args={[container.width, 0.1, container.depth]} />
              <meshStandardMaterial color="#999" />
            </mesh>
            
            {/* Door (front wall that opens) */}
            <mesh
              ref={doorRef}
              position={[0, 0, container.depth/2]}
              rotation={[0, 0, 0]}
              rotation-origin-x={-container.width/2}
            >
              <boxGeometry args={[container.width, container.height, 0.1]} />
              <meshStandardMaterial color="#666" />
            </mesh>
          </group>

          {/* Render all boxes from all layers */}
          {container.layers.flatMap(layer => 
            layer.boxes.map(box => (
              <Box3D key={box.id} box={{
                ...box,
                position: {
                  x: box.position.x - container.width/2 + box.width/2,
                  y: box.position.y - container.height/2 + box.height/2,
                  z: box.position.z - container.depth/2 + box.depth/2 + layer.order * 1.5
                }
              }} />
            ))
          )}

          <OrbitControls enablePan={true} enableZoom={true} enableRotate={true} />
        </Canvas>
      );
    }

    // Box arrangement algorithm
    function arrangeBoxesInLayer(boxes, container) {
      const arrangedBoxes = [];
      let currentX = 0;
      let currentY = 0;
      let maxHeightInRow = 0;

      boxes.forEach(box => {
        // Check if box fits in current row
        if (currentX + box.width > container.width) {
          // Move to next row
          currentX = 0;
          currentY += maxHeightInRow;
          maxHeightInRow = 0;
        }

        // Check if box fits vertically
        if (currentY + box.height > container.height) {
          console.warn("Box doesn't fit in container height");
          return;
        }

        // Position the box
        arrangedBoxes.push({
          ...box,
          position: {
            x: currentX,
            y: currentY,
            z: 0
          }
        });

        // Update tracking variables
        currentX += box.width;
        maxHeightInRow = Math.max(maxHeightInRow, box.height);
      });

      return arrangedBoxes;
    }

    // Main App Component
    function App() {
      const [container, setContainer] = useState(defaultContainer);
      const [activeLayerId, setActiveLayerId] = useState(container.layers[0].id);
      const [viewMode, setViewMode] = useState('2D');
      const [newBox, setNewBox] = useState({ width: 2, height: 2, depth: 2 });
      const [containerSize, setContainerSize] = useState({
        width: defaultContainer.width,
        height: defaultContainer.height,
        depth: defaultContainer.depth
      });

      const activeLayer = container.layers.find(l => l.id === activeLayerId);

      const addBox = () => {
        const updatedLayers = container.layers.map(layer => {
          if (layer.id === activeLayerId) {
            const newBoxWithPosition = {
              ...newBox,
              id: uuidv4(),
              color: `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`,
              position: { x: 0, y: 0, z: 0 }
            };
            return {
              ...layer,
              boxes: arrangeBoxesInLayer([...layer.boxes, newBoxWithPosition], container)
            };
          }
          return layer;
        });

        setContainer({ ...container, layers: updatedLayers });
      };

      const updateContainerSize = () => {
        setContainer({
          ...container,
          width: containerSize.width,
          height: containerSize.height,
          depth: containerSize.depth
        });
      };

      const addLayer = () => {
        const newLayer = {
          id: uuidv4(),
          boxes: [],
          order: container.layers.length
        };
        setContainer({
          ...container,
          layers: [...container.layers, newLayer]
        });
      };

      const removeLayer = (layerId) => {
        if (container.layers.length <= 1) {
          alert("You need at least one layer");
          return;
        }
        
        const updatedLayers = container.layers.filter(l => l.id !== layerId);
        setContainer({ ...container, layers: updatedLayers });
        
        if (activeLayerId === layerId) {
          setActiveLayerId(updatedLayers[0].id);
        }
      };

      const removeBox = (boxId) => {
        const updatedLayers = container.layers.map(layer => {
          if (layer.id === activeLayerId) {
            return {
              ...layer,
              boxes: layer.boxes.filter(b => b.id !== boxId)
            };
          }
          return layer;
        });

        setContainer({ ...container, layers: updatedLayers });
      };

      return (
        <div className="min-h-screen">
          <div className="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            {/* Control Panel */}
            <div className="bg-white p-6 rounded-lg shadow">
              <h1 className="text-2xl font-bold mb-4">📦 Container Box Visualizer</h1>
              
              <div className="flex gap-2 mb-6">
                <button 
                  onClick={() => setViewMode('2D')} 
                  className={`px-4 py-2 rounded ${viewMode === '2D' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  2D View
                </button>
                <button 
                  onClick={() => setViewMode('3D')} 
                  className={`px-4 py-2 rounded ${viewMode === '3D' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  3D View
                </button>
              </div>

              {/* Container Size Controls */}
              <div className="mb-6 p-4 bg-gray-50 rounded">
                <h2 className="text-xl font-semibold mb-2">Container Size</h2>
                <div className="grid grid-cols-3 gap-2 mb-2">
                  <div>
                    <label className="block text-sm font-medium mb-1">Width</label>
                    <input 
                      type="number" 
                      value={containerSize.width}
                      onChange={(e) => setContainerSize({...containerSize, width: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Height</label>
                    <input 
                      type="number" 
                      value={containerSize.height}
                      onChange={(e) => setContainerSize({...containerSize, height: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Depth</label>
                    <input 
                      type="number" 
                      value={containerSize.depth}
                      onChange={(e) => setContainerSize({...containerSize, depth: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                </div>
                <button 
                  onClick={updateContainerSize}
                  className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                  Update Container
                </button>
              </div>

              {/* Box Input Form */}
              <div className="mb-6">
                <h2 className="text-xl font-semibold mb-2">Add New Box</h2>
                <div className="grid grid-cols-3 gap-2 mb-2">
                  <div>
                    <label className="block text-sm font-medium mb-1">Width</label>
                    <input 
                      type="number" 
                      value={newBox.width}
                      onChange={(e) => setNewBox({...newBox, width: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Height</label>
                    <input 
                      type="number" 
                      value={newBox.height}
                      onChange={(e) => setNewBox({...newBox, height: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Depth</label>
                    <input 
                      type="number" 
                      value={newBox.depth}
                      onChange={(e) => setNewBox({...newBox, depth: +e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                </div>
                <button 
                  onClick={addBox}
                  className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 w-full"
                >
                  Add Box to Current Layer
                </button>
              </div>

              {/* Layer Management */}
              <div className="mb-4">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-xl font-semibold">Layers</h2>
                  <button 
                    onClick={addLayer}
                    className="bg-purple-500 text-white px-3 py-1 rounded text-sm"
                  >
                    + Add Layer
                  </button>
                </div>
                <div className="space-y-2">
                  {container.layers.map(layer => (
                    <div 
                      key={layer.id} 
                      className={`p-3 rounded border ${activeLayerId === layer.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                    >
                      <div className="flex justify-between items-center">
                        <div className="flex items-center">
                          <button
                            onClick={() => setActiveLayerId(layer.id)}
                            className={`mr-2 px-2 py-1 rounded ${activeLayerId === layer.id ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                          >
                            Layer {layer.order + 1}
                          </button>
                          <span className="text-sm text-gray-600">
                            {layer.boxes.length} boxes
                          </span>
                        </div>
                        {container.layers.length > 1 && (
                          <button
                            onClick={() => removeLayer(layer.id)}
                            className="text-red-500 hover:text-red-700 text-sm"
                          >
                            Remove
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Visualization Area */}
            <div className="bg-white p-6 rounded-lg shadow">
              {viewMode === '2D' ? (
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <h2 className="text-xl font-semibold">
                      Layer {activeLayer.order + 1} (2D View - Back View)
                    </h2>
                    <div className="text-sm text-gray-600">
                      Container: {container.width} × {container.height} × {container.depth}
                    </div>
                  </div>
                  <Layer2DView layer={activeLayer} container={container} />
                  
                  {/* Box List */}
                  <div className="mt-4">
                    <h3 className="font-medium mb-2">Boxes in this layer:</h3>
                    {activeLayer.boxes.length > 0 ? (
                      <div className="grid grid-cols-2 gap-2">
                        {activeLayer.boxes.map(box => (
                          <div 
                            key={box.id} 
                            className="p-2 border rounded flex justify-between items-center"
                            style={{ backgroundColor: `${box.color}20`, borderColor: box.color }}
                          >
                            <span>
                              {box.width} × {box.height} × {box.depth}
                            </span>
                            <button 
                              onClick={() => removeBox(box.id)}
                              className="text-red-500 hover:text-red-700 text-sm"
                            >
                              ×
                            </button>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-500">No boxes in this layer yet</p>
                    )}
                  </div>
                </div>
              ) : (
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <h2 className="text-xl font-semibold">3D Container View</h2>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => setContainer({...container, layers: [...container.layers].reverse()})}
                        className="bg-gray-200 px-3 py-1 rounded text-sm"
                      >
                        Reverse Layers
                      </button>
                      <button 
                        onClick={() => setDoorOpen(!doorOpen)}
                        className="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
                      >
                        {doorOpen ? 'Close Door' : 'Open Door'}
                      </button>
                    </div>
                  </div>
                  <div className="text-sm text-gray-600 mb-2">
                    {container.layers.length} layers, {container.layers.reduce((sum, layer) => sum + layer.boxes.length, 0)} total boxes
                  </div>
                  <div className="h-[500px] border border-gray-300 rounded">
                    <Container3DView container={container} />
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>